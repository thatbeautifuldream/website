name: Weekly Clarity Data Sync

on:
  schedule:
    # Run weekly on Sundays at 2:00 AM UTC
    - cron: "0 2 * * 0"
  workflow_dispatch: # Allow manual triggering for testing

jobs:
  sync-clarity-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync Clarity Analytics Data
        run: |
          echo "Starting weekly Clarity data sync..."

          # Make request to clarity endpoint for 7 days of data
          response=$(curl -s -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.API_AUTH_TOKEN }}" \
            -d '{"numOfDays": 7}' \
            "https://milindmishra.com/rpc/clarity/project-live-insights")

          # Extract HTTP status code (last 3 characters)
          http_code="${response: -3}"
          response_body="${response%???}"

          echo "HTTP Status Code: $http_code"

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Weekly Clarity data sync successful"
            echo "üìä Synced 7 days of analytics data"
            echo "Response preview: ${response_body:0:200}..."
          else
            echo "‚ùå Weekly Clarity data sync failed"
            echo "Response: $response_body"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "üîÑ Weekly Clarity data sync job completed"
          echo "üìä This job helps populate the clarity analytics cache"
          echo "‚è∞ Next run: $(date -d 'next sunday 2:00' -u '+%Y-%m-%d %H:%M UTC')"
